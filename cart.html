<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart - 29th Day Bakery</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Replace YOUR_LIVE_CLIENT_ID with your actual PayPal Live Client ID from https://developer.paypal.com/dashboard/ -->
    <script src="https://www.paypal.com/sdk/js?client-id=YOUR_LIVE_CLIENT_ID&currency=USD"></script>
</head>
<body>
    <header>
        <img src="29th-day-logo.png" alt="Website Logo" class="Logo">
        <h1></h1>
          <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="behind-the-pie.html">Behind the Pie</a></li>
                <li><a href="menu.html">Menu</a></li>
                <li><a href="cart.html">Cart</a></li>
            </ul>
        </nav>
        <a href="https://www.facebook.com/profile.php?id=61577352540225"
        target="_blank" class="facebook-link">
            <img src="Facebook_Image.jpg" alt="Facebook Icon"
            class="facebook-icon">
        </a>
    </header>
    <main id="cart">
    <h2>Your Cart</h2>
    <table class="cart-table">
        <thead>
            <tr>
                <th>Item</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="cart-items"></tbody>
    </table>
    <div id="cart-total" style="text-align: right; font-size: 1.5rem; font-family: 'Playfair Display', serif; margin: 1rem 0;">
        <strong>Total: $<span id="total-amount">0.00</span></strong>
    </div>
    <button id="proceed-checkout-btn" class="proceed-checkout-btn">Proceed to Checkout</button>
</main>

<!-- Checkout Form Modal -->
<div id="checkout-modal" class="checkout-modal">
    <div class="checkout-modal-content">
        <span class="close-checkout">&times;</span>
        <h2>Checkout Information</h2>
        <form id="checkout-form">
            <div class="form-group">
                <label for="customer-name">Name *</label>
                <input type="text" id="customer-name" name="customer-name" required>
            </div>
            
            <div class="form-group">
                <label for="customer-phone">Phone Number *</label>
                <input type="tel" id="customer-phone" name="customer-phone" required>
            </div>
            
            <div class="form-group">
                <label for="customer-email">Email Address *</label>
                <input type="email" id="customer-email" name="customer-email" required>
            </div>
            
            <div class="form-group">
                <label>Order Type *</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="order-type" value="pickup" required> Pickup
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="order-type" value="delivery" required> Delivery
                    </label>
                </div>
            </div>
            
            <div class="form-group" id="delivery-address-group" style="display: none;">
                <label for="delivery-address">Delivery Address *</label>
                <textarea id="delivery-address" name="delivery-address" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label for="order-notes">Notes (Optional)</label>
                <textarea id="order-notes" name="order-notes" rows="3" placeholder="Any special instructions..."></textarea>
            </div>
            
            <button type="submit" class="next-btn">Next</button>
        </form>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmation-modal" class="checkout-modal">
    <div class="checkout-modal-content">
        <span class="close-confirmation">&times;</span>
        <h2>Confirm Your Order</h2>
        <div id="confirmation-details"></div>
        <div id="paypal-button-container"></div>
    </div>
</div>
<script>
    function updateCart() {
        const cartItems = document.getElementById('cart-items');
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        cartItems.innerHTML = '';
        let total = 0;
        
        cart.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.name}</td>
                <td>$${item.price.toFixed(2)}</td>
                <td><input type="number" value="${item.quantity}" min="1" data-index="${index}"></td>
                <td>$${item.total.toFixed(2)}</td>
                <td><button class="remove-item" data-index="${index}">Remove</button></td>
            `;
            cartItems.appendChild(row);
            total += item.total;
        });
        
        // Update total display
        document.getElementById('total-amount').textContent = total.toFixed(2);
        
        // Show/hide PayPal button based on cart contents
        if (cart.length === 0) {
            document.getElementById('paypal-button-container').style.display = 'none';
        } else {
            document.getElementById('paypal-button-container').style.display = 'block';
        }
    }

    // Event delegation for quantity updates
    document.getElementById('cart-items').addEventListener('change', function(e) {
        if (e.target.tagName === 'INPUT') {
            const index = e.target.dataset.index;
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            cart[index].quantity = parseInt(e.target.value) || 1;
            cart[index].total = cart[index].price * cart[index].quantity;
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCart();
        }
    });

    // Event delegation for remove buttons
    document.getElementById('cart-items').addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item')) {
            const index = e.target.dataset.index;
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            cart.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCart();
        }
    });

    // Store customer information
    let customerInfo = {};

    // Initialize cart on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateCart();
        
        const proceedBtn = document.getElementById('proceed-checkout-btn');
        const checkoutModal = document.getElementById('checkout-modal');
        const confirmationModal = document.getElementById('confirmation-modal');
        const closeCheckout = document.querySelector('.close-checkout');
        const closeConfirmation = document.querySelector('.close-confirmation');
        const checkoutForm = document.getElementById('checkout-form');
        const orderTypeRadios = document.querySelectorAll('input[name="order-type"]');
        const deliveryAddressGroup = document.getElementById('delivery-address-group');
        const deliveryAddress = document.getElementById('delivery-address');
        
        // Show/hide proceed button based on cart
        function toggleProceedButton() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (cart.length === 0) {
                proceedBtn.style.display = 'none';
            } else {
                proceedBtn.style.display = 'block';
            }
        }
        toggleProceedButton();
        
        // Override updateCart to toggle button
        const originalUpdateCart = window.updateCart;
        window.updateCart = function() {
            originalUpdateCart();
            toggleProceedButton();
        };
        
        // Show checkout modal
        proceedBtn.addEventListener('click', function() {
            checkoutModal.classList.add('show');
        });
        
        // Close modals
        closeCheckout.addEventListener('click', function() {
            checkoutModal.classList.remove('show');
        });
        
        closeConfirmation.addEventListener('click', function() {
            confirmationModal.classList.remove('show');
        });
        
        // Show/hide delivery address based on order type
        orderTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'delivery') {
                    deliveryAddressGroup.style.display = 'block';
                    deliveryAddress.setAttribute('required', 'required');
                } else {
                    deliveryAddressGroup.style.display = 'none';
                    deliveryAddress.removeAttribute('required');
                }
            });
        });
        
        // Handle form submission
        checkoutForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Store customer information
            customerInfo = {
                name: document.getElementById('customer-name').value,
                phone: document.getElementById('customer-phone').value,
                email: document.getElementById('customer-email').value,
                orderType: document.querySelector('input[name="order-type"]:checked').value,
                deliveryAddress: document.getElementById('delivery-address').value,
                notes: document.getElementById('order-notes').value
            };
            
            // Show confirmation modal
            showConfirmation();
            checkoutModal.classList.remove('show');
            confirmationModal.classList.add('show');
        });
        
        // Show confirmation details and payment
        function showConfirmation() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const total = cart.reduce((sum, item) => sum + item.total, 0);
            
            let confirmationHTML = `
                <div class="confirmation-section">
                    <h3>Customer Information</h3>
                    <p><strong>Name:</strong> ${customerInfo.name}</p>
                    <p><strong>Email:</strong> ${customerInfo.email}</p>
                    <p><strong>Phone:</strong> ${customerInfo.phone}</p>
                    <p><strong>Order Type:</strong> ${customerInfo.orderType.charAt(0).toUpperCase() + customerInfo.orderType.slice(1)}</p>
                    ${customerInfo.orderType === 'delivery' ? `<p><strong>Delivery Address:</strong> ${customerInfo.deliveryAddress}</p>` : ''}
                    ${customerInfo.notes ? `<p><strong>Notes:</strong> ${customerInfo.notes}</p>` : ''}
                </div>
                
                <div class="confirmation-section">
                    <h3>Order Summary</h3>
                    <table class="confirmation-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Price</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            cart.forEach(item => {
                confirmationHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>$${item.total.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            confirmationHTML += `
                        </tbody>
                    </table>
                    <p class="confirmation-total"><strong>Total: $${total.toFixed(2)}</strong></p>
                </div>
                
                <div class="confirmation-section">
                    <h3>Payment Method</h3>
                </div>
            `;
            
            document.getElementById('confirmation-details').innerHTML = confirmationHTML;
            
            // Initialize PayPal button in confirmation modal
            document.getElementById('paypal-button-container').innerHTML = '';
            paypal.Buttons({
                createOrder: function(data, actions) {
                    // Build detailed order description with customer info
                    let orderDetails = `Customer: ${customerInfo.name} | Email: ${customerInfo.email} | Phone: ${customerInfo.phone} | ${customerInfo.orderType.toUpperCase()}`;
                    if (customerInfo.orderType === 'delivery') {
                        orderDetails += ` | Address: ${customerInfo.deliveryAddress}`;
                    }
                    if (customerInfo.notes) {
                        orderDetails += ` | Notes: ${customerInfo.notes}`;
                    }
                    orderDetails += ` | Items: ${cart.map(item => `${item.quantity}x ${item.name}`).join(', ')}`;
                    
                    return actions.order.create({
                        purchase_units: [{
                            description: orderDetails.substring(0, 127), // PayPal limit is 127 chars
                            custom_id: JSON.stringify({
                                name: customerInfo.name,
                                email: customerInfo.email,
                                phone: customerInfo.phone,
                                orderType: customerInfo.orderType,
                                deliveryAddress: customerInfo.deliveryAddress || 'N/A',
                                notes: customerInfo.notes || 'None'
                            }),
                            amount: {
                                currency_code: 'USD',
                                value: total.toFixed(2),
                                breakdown: {
                                    item_total: {
                                        currency_code: 'USD',
                                        value: total.toFixed(2)
                                    }
                                }
                            },
                            items: cart.map(item => ({
                                name: item.name,
                                unit_amount: {
                                    currency_code: 'USD',
                                    value: item.price.toFixed(2)
                                },
                                quantity: item.quantity.toString()
                            }))
                        }]
                    });
                },
                onApprove: function(data, actions) {
                    return actions.order.capture().then(function(details) {
                        // Close confirmation modal
                        confirmationModal.classList.remove('show');
                        
                        // Show success message
                        alert('ðŸŽ‰ Your order was sent to the kitchen! Thank you, ' + customerInfo.name + '!');
                        
                        // Clear the cart and customer info
                        localStorage.removeItem('cart');
                        customerInfo = {};
                        checkoutForm.reset();
                        updateCart();
                    });
                },
                onError: function(err) {
                    console.error('PayPal error:', err);
                    alert('An error occurred with PayPal. Please try again.');
                }
            }).render('#paypal-button-container');
        }
    });
</script>